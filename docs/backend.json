{
  "entities": {
    "MarketData": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "MarketData",
      "type": "object",
      "description": "Represents real-time market data from various cryptocurrency exchanges.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the MarketData entry."
        },
        "exchange": {
          "type": "string",
          "description": "The name of the exchange (e.g., Binance, Bybit)."
        },
        "symbol": {
          "type": "string",
          "description": "The trading symbol (e.g., BTCUSDT)."
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp of the market data.",
          "format": "date-time"
        },
        "price": {
          "type": "number",
          "description": "The price of the trading symbol."
        },
        "volume": {
          "type": "number",
          "description": "The trading volume of the symbol."
        }
      },
      "required": [
        "id",
        "exchange",
        "symbol",
        "timestamp",
        "price",
        "volume"
      ]
    },
    "TradingSignal": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "TradingSignal",
      "type": "object",
      "description": "Represents a trading signal generated by the AI models.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the TradingSignal."
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp of when the signal was generated.",
          "format": "date-time"
        },
        "symbol": {
          "type": "string",
          "description": "The trading symbol the signal refers to (e.g., BTCUSDT)."
        },
        "signalType": {
          "type": "string",
          "description": "The type of signal (e.g., buy, sell, hold)."
        },
        "confidence": {
          "type": "number",
          "description": "The confidence level of the signal (0 to 1)."
        },
        "modelId": {
          "type": "string",
          "description": "Reference to the AIModel that generated this signal. (Relationship: AIModel 1:N TradingSignal)"
        }
      },
      "required": [
        "id",
        "timestamp",
        "symbol",
        "signalType",
        "confidence",
        "modelId"
      ]
    },
    "AIModel": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "AIModel",
      "type": "object",
      "description": "Represents an AI model used for generating trading signals.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the AIModel."
        },
        "name": {
          "type": "string",
          "description": "The name of the AI model."
        },
        "description": {
          "type": "string",
          "description": "A description of the AI model."
        },
        "version": {
          "type": "string",
          "description": "The version of the AI model."
        },
        "parameters": {
          "type": "string",
          "description": "JSON string with the parameters used for this AI model"
        }
      },
      "required": [
        "id",
        "name",
        "description",
        "version",
        "parameters"
      ]
    },
    "RiskProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "RiskProfile",
      "type": "object",
      "description": "Represents a user's risk profile and associated risk parameters.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the RiskProfile."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the User associated with this risk profile. (Relationship: User 1:N RiskProfile)"
        },
        "valueAtRisk": {
          "type": "number",
          "description": "The Value at Risk (VaR) level."
        },
        "expectedShortfall": {
          "type": "number",
          "description": "The Expected Shortfall (CVaR) level."
        },
        "maxPositionSize": {
          "type": "number",
          "description": "The maximum position size allowed."
        }
      },
      "required": [
        "id",
        "userId",
        "valueAtRisk",
        "expectedShortfall",
        "maxPositionSize"
      ]
    },
    "TradeOrder": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "TradeOrder",
      "type": "object",
      "description": "Represents a trade order placed by the system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the TradeOrder."
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp of when the order was placed.",
          "format": "date-time"
        },
        "symbol": {
          "type": "string",
          "description": "The trading symbol for the order (e.g., BTCUSDT)."
        },
        "orderType": {
          "type": "string",
          "description": "The type of order (e.g., market, limit)."
        },
        "side": {
          "type": "string",
          "description": "The side of the order (e.g., buy, sell)."
        },
        "quantity": {
          "type": "number",
          "description": "The quantity of the asset to trade."
        },
        "price": {
          "type": "number",
          "description": "The price at which to execute the order."
        },
        "status": {
          "type": "string",
          "description": "The status of the order (e.g., open, filled, cancelled)."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the User that created this order. (Relationship: User 1:N TradeOrder)"
        }
      },
      "required": [
        "id",
        "timestamp",
        "symbol",
        "orderType",
        "side",
        "quantity",
        "price",
        "status",
        "userId"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the trading platform.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User."
        },
        "email": {
          "type": "string",
          "description": "The user's email address.",
          "format": "email"
        },
        "username": {
          "type": "string",
          "description": "The user's username."
        },
        "photoURL": {
            "type": "string",
            "description": "URL to the user's profile picture.",
            "format": "uri"
        },
        "riskProfileId": {
          "type": "string",
          "description": "Reference to RiskProfile. (Relationship: User 1:1 RiskProfile)"
        }
      },
      "required": [
        "id",
        "email",
        "username"
      ]
    },
    "Strategy": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Strategy",
      "type": "object",
      "description": "Represents a trading strategy created by a user.",
      "properties": {
        "userId": {
          "type": "string",
          "description": "The ID of the user who owns this strategy."
        },
        "name": {
          "type": "string",
          "description": "The name of the strategy."
        },
        "asset": {
          "type": "string",
          "description": "The asset the strategy trades (e.g., BTC/USDT)."
        },
        "timeframe": {
          "type": "string",
          "description": "The timeframe the strategy operates on (e.g., 1H, 4H)."
        },
        "status": {
          "type": "string",
          "description": "The current status of the strategy (e.g., Active, Paused)."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the strategy was created.",
          "format": "date-time"
        }
      },
      "required": [
        "userId",
        "name",
        "asset",
        "timeframe",
        "status",
        "createdAt"
      ]
    },
     "AIBot": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "AIBot",
      "type": "object",
      "description": "Represents a live, running instance of a user's trading strategy.",
      "properties": {
        "userId": {
          "type": "string",
          "description": "The ID of the user who owns this bot."
        },
        "strategyId": {
          "type": "string",
          "description": "The ID of the strategy this bot is running."
        },
        "name": {
          "type": "string",
          "description": "A user-friendly name for the bot."
        },
        "status": {
          "type": "string",
          "description": "The current status of the bot (e.g., Active, Paused, Error)."
        },
        "pnl": {
            "type": "number",
            "description": "The current profit and loss of the bot."
        },
        "uptime": {
            "type": "string",
            "description": "The duration the bot has been active."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the bot was created.",
          "format": "date-time"
        }
      },
      "required": [
        "userId",
        "strategyId",
        "name",
        "status",
        "pnl",
        "uptime",
        "createdAt"
      ]
    },
    "ApiKey": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ApiKey",
      "type": "object",
      "description": "Represents a user's API key for an exchange.",
      "properties": {
        "userId": {
            "type": "string",
            "description": "The ID of the user who owns this API key."
        },
        "exchange": {
            "type": "string",
            "description": "The name of the exchange (e.g., Binance, Bybit)."
        },
        "publicKey": {
            "type": "string",
            "description": "The public part of the API key."
        },
        "status": {
            "type": "string",
            "description": "The status of the API key (e.g., Active, Expired).",
            "enum": ["Active", "Expired"]
        }
      },
      "required": ["userId", "exchange", "publicKey", "status"]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/market_data/{marketDataId}",
        "definition": {
          "entityName": "MarketData",
          "schema": {
            "$ref": "#/backend/entities/MarketData"
          },
          "description": "Stores real-time market data. All documents in the 'market_data' collection are publicly readable but only writable by authorized data ingestion services (e.g., via service account authentication).",
          "params": [
            {
              "name": "marketDataId",
              "description": "Unique identifier for the market data entry."
            }
          ]
        }
      },
      {
        "path": "/ai_models/{aiModelId}",
        "definition": {
          "entityName": "AIModel",
          "schema": {
            "$ref": "#/backend/entities/AIModel"
          },
          "description": "Stores AI models used for generating trading signals. Read access is generally public, but write access is restricted to authorized personnel or services.",
          "params": [
            {
              "name": "aiModelId",
              "description": "Unique identifier for the AI model."
            }
          ]
        }
      },
      {
        "path": "/ai_models/{aiModelId}/trading_signals/{tradingSignalId}",
        "definition": {
          "entityName": "TradingSignal",
          "schema": {
            "$ref": "#/backend/entities/TradingSignal"
          },
          "description": "Stores trading signals generated by AI models. Each signal is associated with a specific AI model. The 'modelId' field is denormalized from the AIModel document to ensure authorization independence.",
          "params": [
            {
              "name": "aiModelId",
              "description": "Unique identifier for the AI model that generated the signal."
            },
            {
              "name": "tradingSignalId",
              "description": "Unique identifier for the trading signal."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profiles. Access is restricted to the user themselves (read/write own profile) and potentially admins.",
          "params": [
            {
              "name": "userId",
              "description": "Unique identifier for the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/risk_profiles/{riskProfileId}",
        "definition": {
          "entityName": "RiskProfile",
          "schema": {
            "$ref": "#/backend/entities/RiskProfile"
          },
          "description": "Stores risk profiles for users.  The 'userId' field is denormalized to enable authorization independence. Access is restricted to the user themselves and potentially admins.",
          "params": [
            {
              "name": "userId",
              "description": "Unique identifier for the user."
            },
            {
              "name": "riskProfileId",
              "description": "Unique identifier for the risk profile."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/trade_orders/{tradeOrderId}",
        "definition": {
          "entityName": "TradeOrder",
          "schema": {
            "$ref": "#/backend/entities/TradeOrder"
          },
          "description": "Stores trade orders for users. The 'userId' field is denormalized to enable authorization independence. Access is restricted to the user themselves and potentially admins.",
          "params": [
            {
              "name": "userId",
              "description": "Unique identifier for the user."
            },
            {
              "name": "tradeOrderId",
              "description": "Unique identifier for the trade order."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/strategies/{strategyId}",
        "definition": {
          "entityName": "Strategy",
          "schema": {
            "$ref": "#/backend/entities/Strategy"
          },
          "description": "Stores trading strategies created by a user. Access is restricted to the user themselves.",
          "params": [
            {
              "name": "userId",
              "description": "The user's unique ID."
            },
            {
              "name": "strategyId",
              "description": "The strategy's unique ID."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/ai_bots/{aiBotId}",
        "definition": {
          "entityName": "AIBot",
          "schema": {
            "$ref": "#/backend/entities/AIBot"
          },
          "description": "Stores live, running instances of a user's trading strategies (bots). Access is restricted to the user themselves.",
          "params": [
            {
              "name": "userId",
              "description": "The user's unique ID."
            },
            {
              "name": "aiBotId",
              "description": "The bot's unique ID."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/api_keys/{apiKeyId}",
        "definition": {
          "entityName": "ApiKey",
          "schema": {
            "$ref": "#/backend/entities/ApiKey"
          },
          "description": "Stores a user's exchange API keys. Access is restricted to the user themselves.",
          "params": [
            {
              "name": "userId",
              "description": "The user's unique ID."
            },
            {
              "name": "apiKeyId",
              "description": "The API key's unique ID."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to support a professional crypto trading system with a focus on real-time data processing, AI-powered trading signals, automated risk management, and smart order execution. The design prioritizes security, scalability, and debuggability by adhering to the principles of Authorization Independence, Clarity of Intent, DBAC (Database-Based Access Control), and QAPs (Rules are not Filters).\n\n**Authorization Independence:**  To achieve authorization independence, key authorization attributes are denormalized. For instance, TradeOrders are stored under `/users/{userId}/trade_orders/{tradeOrderId}` to ensure clear ownership and simplify security rules. The `RiskProfile` also includes the `userId`, facilitating direct association and authorization.\n\n**Structural Segregation:**  Data with different access requirements are stored in separate collections. User-specific data (TradeOrders, RiskProfiles) are stored under the `/users/{userId}` path, while global AI models are kept in the `/ai_models` collection. This segregation simplifies security rules by ensuring that each collection has a homogeneous security posture.\n\n**Access Modeling:** Path-based ownership is used for user-related data. The Membership Map pattern is not explicitly used because collaborative data management isn't specified in the requirements. For global roles, a dedicated collection `/roles_admin/{uid}` could be created to manage admin access if needed.\n\n**QAPs (Rules are not Filters):**  The structure supports secure `list` operations.  Because TradeOrders are organized under `/users/{userId}/trade_orders/{tradeOrderId}`, listing trade orders for a specific user is straightforward and secure.  AI models can be listed globally with appropriate security rules to prevent unauthorized modifications.\n\n**Example of achieving Authorization Independence with denormalization for TradeOrders:**\nEach `TradeOrder` is stored within the `trade_orders` subcollection of a specific user's document (`/users/{userId}/trade_orders/{tradeOrderId}`). The `TradeOrder` document itself includes the `userId` field. This design eliminates the need for `get()` calls in security rules to verify ownership during creation or modification. The security rule can directly check if `request.auth.uid == resource.data.userId` or `request.auth.uid == userId` (from path) ensuring only the authenticated user can manage their own orders.\n\nThis structure provides a robust foundation for building a secure and scalable crypto trading platform."
  }
}
